<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lebanon Geolocation Game</title>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDUX4nOaDDLMpXPE4kzzG7suF-dYcj-tkc"></script>
  <style>
    #map {
      height: 400px;
      width: 100%;
    }
    #game-info {
      text-align: center;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <h2 style="text-align: center;">Lebanon Geolocation Game</h2>
  <div id="map"></div>
  <div id="game-info">
    <p id="message">Find the target location within the specified region!</p>
    <button onclick="startGame()">Start Game</button>
    <button onclick="retryGeolocation()">Retry Geolocation</button>
    <p><strong>Region:</strong> <span id="region-info"></span></p>
    <p><strong>Target Location:</strong> <span id="target-info"></span></p>
  </div>

  <script>
    let map;
    let playerMarker;
    let targetMarker;

    // Define regions with both popular and lesser-known locations
    const regions = {
      "Beirut": [
        { name: "Beirut Downtown", lat: 33.8951, lng: 35.5057 },
        { name: "Gemmayze", lat: 33.8978, lng: 35.5103 },
        { name: "Karantina", lat: 33.9067, lng: 35.5253 },
        { name: "Corniche Beirut", lat: 33.9051, lng: 35.4733 }
      ],
      "Mount Lebanon": [
        { name: "Jounieh", lat: 33.9808, lng: 35.6174 },
        { name: "Beit Mery", lat: 33.8674, lng: 35.6024 },
        { name: "Chouf Cedar Reserve", lat: 33.6897, lng: 35.6624 },
        { name: "Broummana", lat: 33.8864, lng: 35.5876 }
      ],
      "North Lebanon": [
        { name: "Tripoli Citadel", lat: 34.4367, lng: 35.8525 },
        { name: "Ehden", lat: 34.2986, lng: 35.9787 },
        { name: "Ras Bsharri", lat: 34.2516, lng: 36.0102 },
        { name: "Batroun Old Souks", lat: 34.2545, lng: 35.6582 }
      ],
      "South Lebanon": [
        { name: "Sidon Sea Castle", lat: 33.5576, lng: 35.3723 },
        { name: "Tyre Al-Bass Site", lat: 33.2707, lng: 35.2033 },
        { name: "Mleeta Resistance Landmark", lat: 33.4729, lng: 35.5851 },
        { name: "Qana Caves", lat: 33.2250, lng: 35.2995 }
      ],
      "Bekaa Valley": [
        { name: "Baalbek Temples", lat: 34.0058, lng: 36.2181 },
        { name: "Zahle Winery", lat: 33.8492, lng: 35.9077 },
        { name: "Anjar Ruins", lat: 33.7256, lng: 35.9336 },
        { name: "Taanayel Lake", lat: 33.8251, lng: 35.8714 }
      ]
    };

    let target;
    let currentRegion;
    const proximityThreshold = 0.01; // ~1 km

    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 33.8938, lng: 35.5018 },
        zoom: 8,
      });
    }

    function startGame() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(updatePlayerLocation, handleError, { enableHighAccuracy: true });
        setNewTarget();
      } else {
        alert("Geolocation is not supported by this browser.");
      }
    }

    function retryGeolocation() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(updatePlayerLocation, handleError, { enableHighAccuracy: true });
      } else {
        alert("Geolocation is not supported by this browser.");
      }
    }

    function setNewTarget() {
      const regionKeys = Object.keys(regions);
      currentRegion = regionKeys[Math.floor(Math.random() * regionKeys.length)]; // Randomly select a region
      const regionLocations = regions[currentRegion];
      target = regionLocations[Math.floor(Math.random() * regionLocations.length)]; // Randomly select location in region

      document.getElementById("region-info").textContent = currentRegion;
      document.getElementById("target-info").textContent = `${target.name} (Lat: ${target.lat}, Lng: ${target.lng})`;

      if (targetMarker) targetMarker.setMap(null);
      targetMarker = new google.maps.Marker({
        position: { lat: target.lat, lng: target.lng },
        map: map,
        label: "T",
      });
    }

    function updatePlayerLocation(position) {
      const playerPos = { lat: position.coords.latitude, lng: position.coords.longitude };
      if (playerMarker) playerMarker.setMap(null);

      playerMarker = new google.maps.Marker({
        position: playerPos,
        map: map,
        label: "P",
      });

      map.setCenter(playerPos);

      checkProximity(playerPos);
    }

    function checkProximity(playerPos) {
      const distance = getDistance(playerPos.lat, playerPos.lng, target.lat, target.lng);
      if (distance <= proximityThreshold) {
        document.getElementById("message").textContent = `Congratulations! You've reached ${target.name} in ${currentRegion}.`;
        setTimeout(setNewTarget, 2000); // Set a new target after a short delay
      } else {
        document.getElementById("message").textContent = `Get closer to ${target.name} in ${currentRegion}! Distance: ${(distance * 1000).toFixed(1)} m`;
      }
    }

    function getDistance(lat1, lng1, lat2, lng2) {
      const R = 6371; // Radius of Earth in km
      const dLat = degreesToRadians(lat2 - lat1);
      const dLng = degreesToRadians(lng2 - lng1);
      const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(degreesToRadians(lat1)) * Math.cos(degreesToRadians(lat2)) *
                Math.sin(dLng / 2) * Math.sin(dLng / 2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c; // Distance in km
    }

    function degreesToRadians(degrees) {
      return degrees * (Math.PI / 180);
    }

    function handleError(error) {
      switch(error.code) {
        case error.PERMISSION_DENIED:
          document.getElementById("message").textContent = "Location access denied. Please enable location access and try again.";
          break;
        case error.POSITION_UNAVAILABLE:
          document.getElementById("message").textContent = "Location information is unavailable. Retry in a moment.";
          break;
        case error.TIMEOUT:
          document.getElementById("message").textContent = "Location request timed out. Please retry.";
          break;
        case error.UNKNOWN_ERROR:
          document.getElementById("message").textContent = "An unknown error occurred.";
          break;
      }
    }

    window.onload = initMap;
  </script>
</body>
</html>
